@using MonackFr.Mvc.ViewModels
@{
	ViewBag.Title = "Default";
}

<h2>MonackFr</h2>
<a href="javascript:void(0)" class="home-button">Home</a>
<div class="tiles">
	<ul>	
	</ul>
</div>

<ul class="modules">
	@foreach (Module module in ViewBag.Modules)
	{		
		<li class="module @module.CssSystemName">
			<h2>@module.Name</h2>
			<ul class="menu"></ul>
		</li>
	}
</ul>

@section Scripts {
	<script type="text/javascript">

		$(document).ready(function () {
			$(".home-button").bind("click", function () {
				$(".module").hide();
				$(".tiles").show();
			});

			

			$(".module").hide();
			$(".tiles").show();

			$.post('@Url.Action("GetModules", "Module")', function (modules) {
				$.each(modules, getMenuItems)
			})
		});

		var getMenuItems = function (index, module) {			
			$.post('@Url.Action("GetMenu", "Module")', { systemName: module.SystemName }, function (menuItems) {
				$.each(menuItems, function (index, menuItem) {
					console.log(menuItem);
					var menuItemLi = $("<li>")
						.addClass("menu-item")
						.attr("data-panel-systemname", menuItem.CssSystemName)
						.attr("data-default", menuItem.Default)						
						.text(menuItem.Label);
					$("." + module.CssSystemName + " ul.menu").append(menuItemLi);
					$.get(menuItem.Url, function (content) {
						$("." + module.CssSystemName).append(
							$("<div>")
								.addClass("panel")
								.addClass(menuItem.CssSystemName)
								.html(content)
						);
					});
					$(".menu-item").bind("click", function () {
						var panelName = $(this).attr("data-panel-systemname");
						showPanel(panelName);
					});
				});
			});
		};

		var showModule = function (module) {
			$(".tiles").hide();
			$(".module").hide();
			$(".panel").hide();
			$("." + module.CssSystemName).show();

			var defaultMenuItem = $("." + module.CssSystemName + " ul.menu li.menu-item[data-default='true']").first().attr("data-panel-systemname");
			if ($.isEmptyObject(defaultMenuItem)) {
				defaultMenuItem = $("." + module.CssSystemName + " ul.menu li.menu-item").first().attr("data-panel-systemname");
			}
			showPanel(defaultMenuItem);
		};

		var showPanel = function (panelName) {
			$(".panel").hide();
			$("." + panelName).show();
		};

		function Tile(data) {
			self.Title = ko.observable(data.Title);
			self.Copyright = ko.observable();
			self.Url = ko.observable();
		}

		function MenuItem(data) {
			self.Label = k.observable(data.Title);
		}

		function TileViewModel() {
			var self = this;
			self.tiles = ko.observableArray();
			$.post('@Url.Action("GetTiles", "Tile")', function (data) {
				var mappedTiles = $.map(data, function (item) { return new Tile(item) });
				self.tiles(mappedTiles);
				$("div.tiles").tiles(data, showModule);				
			});
		}

		ko.applyBindings(new TileViewModel());
</script>
}




